# TOTP (Time-based One-Time Password) Implementation

## Overview

This implementation adds mandatory Two-Factor Authentication (2FA) using TOTP for all password-based sign-ins and sign-ups in the HKBase application.

## Features

### 1. Mandatory TOTP Setup During Sign-Up

- After creating an account with email/password, users must set up TOTP
- QR code is displayed for easy setup with authenticator apps (Google Authenticator, Authy, etc.)
- Manual entry code provided as fallback
- 10 backup codes generated for account recovery
- Setup cannot be bypassed - users must complete TOTP setup to access the application

### 2. TOTP Verification During Sign-In

- Password authentication validates credentials first
- If TOTP is enabled, a second step prompts for the 6-digit code
- Supports both TOTP codes and backup codes
- Clear error messages for invalid codes
- Backup codes are single-use and removed after use

### 3. User Profile TOTP Management

Users can manage their TOTP settings from their profile:

- **View Status**: See if 2FA is enabled and remaining backup codes count
- **Enable 2FA**: Set up TOTP if not already enabled
- **Disable 2FA**: Remove TOTP protection (requires password or TOTP verification)
- **Regenerate Backup Codes**: Generate new backup codes (old ones are invalidated)
- **Download/Copy Codes**: Save backup codes securely

### 4. Admin TOTP Management

Admins can manage TOTP for any user:

- View all users and their 2FA status
- Reset TOTP for locked-out users
- Force disable 2FA for security incidents
- No password required for admin operations

## Technical Implementation

### Database Schema

```prisma
model User {
  // ... existing fields
  totpSecret      String?   // Encrypted TOTP secret
  totpEnabled     Boolean   @default(false)
  totpBackupCodes String[]  @default([]) // Hashed backup codes
}
```

### Key Components

#### 1. TOTP Utilities (`lib/auth/totp.ts`)

- `generateTOTPSecret()`: Creates new TOTP secret
- `generateQRCode()`: Generates QR code data URL
- `verifyTOTP()`: Validates TOTP tokens
- `generateBackupCodes()`: Creates backup codes
- `encrypt()/decrypt()`: Secures TOTP secrets in database

#### 2. Server Actions (`app/actions/totp-actions.ts`)

- `setupTOTP()`: Initiates TOTP setup
- `enableTOTP()`: Activates TOTP after verification
- `verifyUserTOTP()`: Validates TOTP codes
- `disableTOTP()`: Removes TOTP protection
- `regenerateBackupCodes()`: Creates new backup codes
- `getTOTPStatus()`: Retrieves user's 2FA status

#### 3. Authentication Flow (`lib/auth/index.ts`)

Updated credentials provider to check for TOTP:

```typescript
// After password verification
if (dbUser.totpEnabled && dbUser.totpSecret) {
  if (!credentials.totpCode) {
    throw new Error("TOTP verification required");
  }
  // Verify TOTP code
}
```

#### 4. Sign-In Page (`app/(auth)/sign-in/page.tsx`)

Two-step authentication process:

1. Email + Password verification
2. TOTP code verification (if enabled)

#### 5. Sign-Up Page (`app/(auth)/sign-up/page.tsx`)

Three-step registration process:

1. Account creation
2. TOTP setup (scan QR code)
3. Backup codes display

#### 6. Profile Management (`app/(app)/profile/_components/totp-management.tsx`)

Complete TOTP management interface for users

#### 7. Admin Management (`app/(app)/profile/_components/user-management.tsx`)

Admin controls for user TOTP management

## Security Features

### Encryption

- TOTP secrets are encrypted using AES-256-CBC before storage
- Encryption key stored in environment variable (`TOTP_ENCRYPTION_KEY`)
- Each secret has unique initialization vector (IV)

### Backup Codes

- Generated using cryptographically secure random bytes
- Hashed with bcrypt before storage (salt rounds: 10)
- Single-use - removed from database after successful use
- 10 codes generated by default

### Time Window

- 30-second time step (standard TOTP)
- Accepts codes within ±1 time window (90 seconds total)
- Prevents replay attacks

### Rate Limiting

Recommended to implement:

- Max 5 failed TOTP attempts per session
- Temporary account lock after repeated failures
- IP-based rate limiting

## Usage

### For Users

#### Setting Up TOTP

1. Sign up or enable 2FA from profile
2. Scan QR code with authenticator app
3. Enter 6-digit code to verify
4. Save backup codes securely

#### Signing In

1. Enter email and password
2. Enter 6-digit code from authenticator app
3. (Alternative) Use backup code if authenticator unavailable

#### Managing TOTP

1. Go to Profile → Two-Factor Authentication
2. View status and remaining backup codes
3. Regenerate backup codes if needed
4. Disable 2FA if necessary (requires verification)

### For Admins

#### Resetting User TOTP

1. Go to Profile → User Management
2. Find the user in the table
3. Click menu (⋮) → Reset 2FA
4. Confirm the action

## Environment Variables

```bash
# Required for TOTP encryption
TOTP_ENCRYPTION_KEY=<base64-encoded-32-byte-key>
```

Generate a secure key:

```bash
openssl rand -base64 32
```

## Dependencies

```json
{
  "otpauth": "^9.4.1", // TOTP generation and verification
  "qrcode": "^1.5.4", // QR code generation
  "@types/qrcode": "^1.5.6" // TypeScript types
}
```

## Compatible Authenticator Apps

- Google Authenticator (iOS, Android)
- Microsoft Authenticator (iOS, Android)
- Authy (iOS, Android, Desktop)
- 1Password (cross-platform)
- Bitwarden (cross-platform)
- Any RFC 6238 compliant TOTP app

## Error Handling

### Common Errors

- **"TOTP verification required"**: User has 2FA enabled but didn't provide code
- **"Invalid TOTP code"**: Wrong code or expired token
- **"Invalid backup code"**: Backup code already used or doesn't exist

### Recovery Options

1. Use backup codes if authenticator unavailable
2. Contact admin for TOTP reset
3. Use alternative sign-in method (OAuth)

## Best Practices

### For Users

- Keep backup codes in secure location (password manager, encrypted file)
- Don't screenshot backup codes
- Enable 2FA on authenticator app itself
- Use multiple backup methods

### For Admins

- Only reset TOTP when absolutely necessary
- Verify user identity before TOTP reset
- Monitor TOTP reset patterns for abuse
- Keep audit logs of TOTP operations

### For Developers

- Never log TOTP secrets or codes
- Rotate encryption keys periodically
- Implement rate limiting
- Add audit logging for TOTP operations
- Consider adding WebAuthn as alternative

## Future Enhancements

- [ ] WebAuthn/FIDO2 support
- [ ] SMS backup codes
- [ ] TOTP session trust (remember device)
- [ ] Admin audit logs for TOTP operations
- [ ] Bulk TOTP operations for admins
- [ ] Recovery email for TOTP reset
- [ ] TOTP setup reminder for OAuth users

## Testing

### Manual Testing Checklist

- [ ] Sign up with new account and complete TOTP setup
- [ ] Sign in with TOTP code
- [ ] Sign in with backup code
- [ ] Regenerate backup codes
- [ ] Disable and re-enable TOTP
- [ ] Admin reset user TOTP
- [ ] Test invalid codes
- [ ] Test expired codes

### Test Accounts

Create test accounts with different states:

- User with TOTP enabled
- User without TOTP
- Admin account
- Locked account

## Troubleshooting

### Time Sync Issues

If codes are consistently rejected:

1. Check server time synchronization
2. Verify authenticator app time settings
3. Use backup codes as temporary workaround

### Lost Authenticator

1. Use backup code to sign in
2. Immediately regenerate backup codes
3. Set up new authenticator
4. If no backup codes, contact admin

### Database Migration

After schema changes, run:

```bash
pnpm db:gen
pnpm db:migrate
```

## Support

For issues or questions:

1. Check this documentation
2. Review error messages
3. Contact system administrator
4. File issue in project repository
